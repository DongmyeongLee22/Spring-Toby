# Chapter6. 테스트 컨텍스트 프레임워크
## 6.1 테스트 컨텍스트 프레임워크
- 스프링은 테스트에 사용되는 애플리케이션 컨텍스트를 생성하고 관리하고 테스트에 적용해주는 기능을 가진 테스트 프레임워크를 제공한다.
- 이를 테스트 컨텍스트 프레임워크라고 부른다. 테스트 컨텍스트 프레임워크는 스프링의 IoC/DI를 지원하는 애플리케이션 컨텍스트를 테스트에서 효과적으로 사용하게 해준다.

### 6.1.1 테스트 프레임워크과 컨텍스트 테스트
#### 테스트용 애플리케이션 컨텍스트 캐싱과 설정파일
- JUnit은 테스트 메서드마다 매번 테스트 클래스의 새로운 오브젝트를 생성한다. 그러므로 모든 테스트는 서로 영향을 주지 않고 독립적으로 실행됨을 보장한다.
- 각 테스트가 독립적이라고 매번 스프링의 컨텍스트를 새로 만드는건 비효율적이다.
- 스프링 컨텍스트는 매우 가벼운 오브젝트이며 설정을 읽고 분석하는 작업은 매우 빠르게 진행되나 빈 오브젝트들 중 많은 초기화 작업을 필요로 하는 것들이 있다.
- 이런 초기화 작업이 테스트마다 반복되면 테스트에 많은 부담을 줄 수 있다.
- 그랫 스프링은 테스트가 사용하는 컨텍스트를 캐싱해서 여러 테스트에서 하나의 컨텍스트를 공유할 수 있는 방법을 제공한다.
- 테스트용 컨텍스트 공유는 해당 테스트 클래스 내에서 뿐만아니라 여러 테스트 클래스 사이에서도 가능하다.
- 따라서 테스트는 매우 빠르게 실행됨을 보장할 수 있다.
- @ContextConfiguration설정이 같은 파일을 바라보고 있다면 여러 클래스간에서도 하나의 컨텍스트만을 생성하게 된다.

### 6.1.2 테스트 코드의 테스트 컨텍스트 활용
#### 테스트 컨텍스트로부터 DI 받기
- 테스트 클래스의 오브젝트는 테스트 메서드마다 새로 만들어지므로 DI작업도 매번 일어난다.
- 따라서 클래스 내의 모든 테스트 메서드에서 공통적으로 필요한 빈 위주로 DI를 진행하고 특정 메서드에서만 사용한다면 getBean()을 사용하는것을 고려해보자.

#### 공유 컨텍스트 사용 시 주의점
- 컨텍스트를 공유하는 테스트 메서드는 컨텍스트가 자신이 독점하는 것이 아니므로 그 구성이나 내부 정보를 함부로 변경해서는 안된다.
- 내부 정보를 변경했다면 반드시 원 상태로 복귀하고 테스트를 끝내야 한다.
- 테스트는 실행 순서와 환경에 영향을 받지 않아야 한다. 테스트는 모두 고립돼서 동작해야하고 테스트 결과도 자신이 검증하는 코드가 바뀌지 않는 한 항상 일정해야 한다.
- 컨텍스트 내의 빈을 테스트하는 중에 특정 파일을 생성하는 기능을 테스트했다면 테스트가 끝난 후 해당 파일을 제거해주는 것이 좋다.
- 어쩔 수 없이 컨텍스트의 빈 오브젝트를 조작하고 수정하는 작업이 필요하다면 @DiritesContext 애노테이션을 붙여 컨텍스트를 새로 만들게 하는것이 좋다.
- 보통 메서드단에 붙이지만 클래스 레벨에 부여하여 모든 메서드에 설정할 수도 있다.

---

## 6.2 트랜잭션 지원 테스트
### 6.2.1 테스트의 트랜잭션 지원 필요
#### DAO 단독 테스트
- DAO만 단독으로 테스트시 JdbcTemplate는 트랜잭션을 자동으로 시작해주지만 JPA나 하이버네이트의 경우 트랜잭션이 시작되지 않은 채로 동작되어 예외가 발생한다.
- JdbcTemplate을 사용하더라도 두 개이상의 DAO 메서드의 작업을 하나의 트랜잭션으로 묶는 테스트는 작성할 수 없다.
- 이렇듯 DAO 테스트를 작성하는 것은 쉽지 않다.

#### 롤백 테스트
- 각 테스트는 독립적이어야 하기때문에 매 테스트가 수행된 후 해당 데이터베이스의 변화는 롤백되어야 할 것이다.

### 6.2.2 트랜잭션 지원 테스트 작성 방법
#### 트랜잭션 매니저
- 스프링의 모든 트랜잭션은 트랜잭션 매니저를 이용해 만드렁지고 관리된다.
- 빈으로 등록되는 PlatformTransactionManger을 이용하여 트랜잭션을 설정할 수 있다.

#### @Transactional 테스트
- 스프링 AOP는 빈 오브젝트에만 적용이 되기 때문에 테스트에서 AOP를 적용하여 @Transactional 기능을 구현할 수 없다.
- 하지만 스프링 테스트 컨텍스트 프레임워크는 마치 AOP를 적용한 것 처럼 유사한 방식으로 이를 지원해준다.
- 테스트에서 @Transactional 사용시 빈으로 등록된 트랜잭션 매니저를 통해 트랜잭션 제어를 구현한다.
- 테스트의 @Transactional은 서비스 계층의 트랜잭션과 중요한 차이점은 강제 롤백 설정이 되어 있기 때문에 @Transactional만으로 롤백 기능을 동작시킬 수 있다.
- @Rollback(false)를 하면 해당 롤백기능을 끌 수도 있다.
- 트랜잭션은 @BeforeEach, @AfterEach에도 적용되므로 트랜잭션이 완전히 종료된 후의 작업은 @BeforeTransaction, @AfterTransaction이 붙은 메서드를 사용하면 된다.

#### ORM 롤백 트랜잭션 테스트의 주의사항
- ORM은 기본적으로 결과를 DB에 즉시 반영하지 않고 메모리에 변경사항을 저장해두고 필요한 시점에 DB에 반영하는 최적화를 위한 트랜잭션 캐싱 기법을 사용한다.
- 테스트 시 1차 캐시를 잘 이해하고 직접 flush, clear를 해주는게 좋다.
